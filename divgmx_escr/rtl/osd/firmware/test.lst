# file opened: test.asm
  1   0000              ; ------------------------------------------------------------------[08.05.2017]
  2   0000              ; DivGMX Test By MVV <mvvproject@gmail.com>
  3   0000              ; -----------------------------------------------------------------------------
  4   0000
  5   0000              	DEVICE	ZXSPECTRUM48
  6   0000
  7   0000              osd_buffer	equ #0c00	; OSD buffer start address
  8   0000              osd_buffer_size	equ 1024
  9   0000              stack_top	equ #0bfe
 10   0000
 11   0000
 12   0000              	org #0000
 13   0000              startprog:
 14   0000 F3           	di
 15   0001 31 FE 0B     	ld sp,stack_top
 16   0004 FD 21 62 03  	ld iy,list
 17   0008 CD 36 01     	call cls		; очистка OSD буфера
 18   000B
 19   000B 21 1D 02     	ld hl,menu
 20   000E CD 42 01     	call print_str		; печать в OSD буфер
 21   0011
 22   0011              q0
 23   0011
 24   0011 01 01 00     	ld bc,#0001		;#7ffd
 25   0014 ED 78        	in a,(c)
 26   0016 21 0C 01     	ld hl,#010c
 27   0019 FD 74 00     	ld (iy+0),h		;y
 28   001C FD 75 01     	ld (iy+1),l		;x
 29   001F CD A5 01     	call print_hex
 30   0022
 31   0022 01 01 01     	ld bc,#0101		;#xxfe
 32   0025 ED 78        	in a,(c)
 33   0027 FD 36 01 14  	ld (iy+1),#14		;x
 34   002B CD A5 01     	call print_hex
 35   002E
 36   002E 01 01 0E     	ld bc,#0e01		;pc
 37   0031 ED 78        	in a,(c)
 38   0033 FD 36 01 1A  	ld (iy+1),#1a		;x
 39   0037 CD A5 01     	call print_hex
 40   003A 01 01 0F     	ld bc,#0f01		;pc
 41   003D ED 78        	in a,(c)
 42   003F CD A5 01     	call print_hex
 43   0042
 44   0042 01 01 0D     	ld bc,#0d01
 45   0045 ED 78        	in a,(c)
 46   0047 FD 36 01 23  	ld (iy+1),#23		;x
 47   004B CB 67        	bit 4,a			;ROM:Std/On
 48   004D 21 5E 03     	ld hl,str_std
 49   0050 28 03        	jr z,q2
 50   0052 21 56 03     	ld hl,str_on
 51   0055              q2
 52   0055 CD 42 01     	call print_str
 53   0058
 54   0058 01 01 0D     	ld bc,#0d01
 55   005B ED 78        	in a,(c)
 56   005D FD 36 01 2B  	ld (iy+1),#2b		;x
 57   0061 CB 6F        	bit 5,a			;KBD:Std/USB
 58   0063 21 5E 03     	ld hl,str_std
 59   0066 28 03        	jr z,q3
 60   0068 21 5A 03     	ld hl,str_usb
 61   006B              q3
 62   006B CD 42 01     	call print_str
 63   006E
 64   006E 01 01 0D     	ld bc,#0d01		;
 65   0071 ED 78        	in a,(c)
 66   0073 FD 36 01 33  	ld (iy+1),#33		;x
 67   0077 CB 5F        	bit 3,a			;BDI:0/1
 68   0079 3E 30        	ld a,"0"
 69   007B 28 01        	jr z,q5
 70   007D 3C           	inc a
 71   007E              q5
 72   007E CD 74 01     	call print_char
 73   0081
 74   0081 01 01 08     	ld bc,#0801		;#xxe3
 75   0084 ED 78        	in a,(c)
 76   0086 21 0C 02     	ld hl,#020c
 77   0089 FD 74 00     	ld (iy+0),h		;y
 78   008C FD 75 01     	ld (iy+1),l		;x
 79   008F CD A5 01     	call print_hex
 80   0092
 81   0092 01 01 0D     	ld bc,#0d01		;
 82   0095 ED 78        	in a,(c)
 83   0097 FD 36 01 14  	ld (iy+1),#14		;x
 84   009B CB 7F        	bit 7,a			;AMAP:0/1
 85   009D 3E 30        	ld a,"0"
 86   009F 28 01        	jr z,q1
 87   00A1 3C           	inc a
 88   00A2              q1
 89   00A2 CD 74 01     	call print_char
 90   00A5
 91   00A5 01 01 0D     	ld bc,#0d01
 92   00A8 ED 78        	in a,(c)
 93   00AA FD 36 01 16  	ld (iy+1),#16		;x
 94   00AE CB 77        	bit 6,a			;DivMMC:on/off
 95   00B0 21 52 03     	ld hl,str_off
 96   00B3 28 03        	jr z,q4
 97   00B5 21 56 03     	ld hl,str_on
 98   00B8              q4
 99   00B8 CD 42 01     	call print_str
100   00BB
101   00BB 01 01 02     	ld bc,#0201		;#fadf
102   00BE ED 78        	in a,(c)
103   00C0 FD 36 01 27  	ld (iy+1),39		;x
104   00C4 CD A5 01     	call print_hex
105   00C7
106   00C7 01 01 03     	ld bc,#0301		;#fbdf
107   00CA ED 78        	in a,(c)
108   00CC FD 36 01 2F  	ld (iy+1),47		;x
109   00D0 CD A5 01     	call print_hex
110   00D3
111   00D3 01 01 04     	ld bc,#0401		;#ffdf
112   00D6 ED 78        	in a,(c)
113   00D8 FD 36 01 37  	ld (iy+1),55		;x
114   00DC CD A5 01     	call print_hex
115   00DF
116   00DF 01 01 05     	ld bc,#0501		;#xadf
117   00E2 ED 78        	in a,(c)
118   00E4 FD 36 01 47  	ld (iy+1),71		;x
119   00E8 CD A5 01     	call print_hex
120   00EB
121   00EB 01 01 06     	ld bc,#0601		;#xbdf
122   00EE ED 78        	in a,(c)
123   00F0 FD 36 01 4F  	ld (iy+1),79		;x
124   00F4 CD A5 01     	call print_hex
125   00F7
126   00F7 01 01 07     	ld bc,#0701		;#xfdf
127   00FA ED 78        	in a,(c)
128   00FC FD 36 01 57  	ld (iy+1),87		;x
129   0100 CD A5 01     	call print_hex
130   0103
131   0103
132   0103
133   0103 01 01 09     	ld bc,#0901		;#0f
134   0106 ED 78        	in a,(c)
135   0108 FD 36 01 68  	ld (iy+1),104		;x
136   010C CD A5 01     	call print_hex
137   010F
138   010F 01 01 0A     	ld bc,#0a01		;#1f
139   0112 ED 78        	in a,(c)
140   0114 FD 36 01 6E  	ld (iy+1),110		;x
141   0118 CD A5 01     	call print_hex
142   011B
143   011B 01 01 0B     	ld bc,#0b01		;#4f
144   011E ED 78        	in a,(c)
145   0120 FD 36 01 74  	ld (iy+1),116		;x
146   0124 CD A5 01     	call print_hex
147   0127
148   0127 01 01 0C     	ld bc,#0c01		;#5f
149   012A ED 78        	in a,(c)
150   012C FD 36 01 7D  	ld (iy+1),125		;x
151   0130 CD A5 01     	call print_hex
152   0133
153   0133 C3 11 00     	jp q0
154   0136
155   0136
156   0136
157   0136              ; -----------------------------------------------------------------------------
158   0136              ; clear OSD buffer
159   0136              ; -----------------------------------------------------------------------------
160   0136              cls
161   0136 21 00 0C     	ld hl,osd_buffer
162   0139 3E 10        	ld a,#10
163   013B              cls1
164   013B 36 20        	ld (hl)," "
165   013D 23           	inc hl
166   013E BC           	cp h
167   013F 20 FA        	jr nz,cls1
168   0141 C9           	ret
169   0142
170   0142              ; -----------------------------------------------------------------------------
171   0142              ; print string i: hl - pointer to string zero-terminated
172   0142              ; -----------------------------------------------------------------------------
173   0142              print_str
174   0142 7E           	ld a,(hl)
175   0143 FE 17        	cp 23
176   0145 28 10        	jr z,print_pos_xy
177   0147 FE 18        	cp 24
178   0149 28 19        	jr z,print_pos_x
179   014B FE 19        	cp 25
180   014D 28 1D        	jr z,print_pos_y
181   014F 23           	inc hl
182   0150 B7           	or a
183   0151 C8           	ret z
184   0152 CD 74 01     	call print_char
185   0155 18 EB        	jr print_str
186   0157              print_pos_xy
187   0157 23           	inc hl
188   0158 7E           	ld a,(hl)
189   0159 FD 77 01     	ld (iy+1),a		; x-coord
190   015C 23           	inc hl
191   015D 7E           	ld a,(hl)
192   015E FD 77 00     	ld (iy+0),a		; y-coord
193   0161 23           	inc hl
194   0162 18 DE        	jr print_str
195   0164              print_pos_x
196   0164 23           	inc hl
197   0165 7E           	ld a,(hl)
198   0166 FD 77 01     	ld (iy+1),a		; x-coord
199   0169 23           	inc hl
200   016A 18 D6        	jr print_str
201   016C              print_pos_y
202   016C 23           	inc hl
203   016D 7E           	ld a,(hl)
204   016E FD 77 00     	ld (iy+0),a		; y-coord
205   0171 23           	inc hl
206   0172 18 CE        	jr print_str
207   0174
208   0174              ; -----------------------------------------------------------------------------
209   0174              ; print character i: a - ansi char
210   0174              ; -----------------------------------------------------------------------------
211   0174              print_char
212   0174 E5           	push hl
213   0175 C5           	push bc
214   0176 FE 0D        	cp 13
215   0178 28 18        	jr z,pchar2
216   017A
217   017A 26 0C        	ld h,high osd_buffer	; osd_buffer
218   017C FD 6E 01     	ld l,(iy+1)		; x
219   017F FD 46 00     	ld b,(iy+0)		; y
220   0182 0E 00        	ld c,0
221   0184 CB 08        	rrc b
222   0186 CB 19        	rr c
223   0188 09           	add hl,bc
224   0189
225   0189 77           	ld (hl),a
226   018A FD 7E 01     	ld a,(iy+1)		; x
227   018D 3C           	inc a
228   018E FE 80        	cp 128
229   0190 38 0D        	jr c,pchar1
230   0192              pchar2
231   0192 FD 7E 00     	ld a,(iy+0)		; y
232   0195 3C           	inc a
233   0196 FE 08        	cp 8
234   0198 38 01        	jr c,pchar0
235   019A AF           	xor a
236   019B              pchar0
237   019B FD 77 00     	ld (iy+0),a
238   019E AF           	xor a
239   019F              pchar1
240   019F FD 77 01     	ld (iy+1),a
241   01A2 C1           	pop bc
242   01A3 E1           	pop hl
243   01A4 C9           	ret
244   01A5
245   01A5              ; -----------------------------------------------------------------------------
246   01A5              ; print hexadecimal i: a - 8 bit number
247   01A5              ; -----------------------------------------------------------------------------
248   01A5              print_hex
249   01A5 5F           	ld e,a
250   01A6 E6 F0        	and $f0
251   01A8 0F           	rrca
252   01A9 0F           	rrca
253   01AA 0F           	rrca
254   01AB 0F           	rrca
255   01AC CD B2 01     	call hex2
256   01AF 7B           	ld a,e
257   01B0 E6 0F        	and $0f
258   01B2              hex2
259   01B2 FE 0A        	cp 10
260   01B4 30 05        	jr nc,hex1
261   01B6 C6 30        	add 48
262   01B8 C3 74 01     	jp print_char
263   01BB              hex1
264   01BB C6 37        	add 55
265   01BD C3 74 01     	jp print_char
266   01C0
267   01C0              ; -----------------------------------------------------------------------------
268   01C0              ; print decimal i: l,d,e - 24 bit number , e - low byte
269   01C0              ; -----------------------------------------------------------------------------
270   01C0              print_dec
271   01C0 DD 21 05 02  	ld ix,dectb_w
272   01C4 06 08        	ld b,8
273   01C6 26 00        	ld h,0
274   01C8              lp_pdw1
275   01C8 0E 2F        	ld c,"0"-1
276   01CA              lp_pdw2
277   01CA 0C           	inc c
278   01CB 7B           	ld a,e
279   01CC DD 96 00     	sub (ix+0)
280   01CF 5F           	ld e,a
281   01D0 7A           	ld a,d
282   01D1 DD 9E 01     	sbc (ix+1)
283   01D4 57           	ld d,a
284   01D5 7D           	ld a,l
285   01D6 DD 9E 02     	sbc (ix+2)
286   01D9 6F           	ld l,a
287   01DA 30 EE        	jr nc,lp_pdw2
288   01DC 7B           	ld a,e
289   01DD DD 86 00     	add (ix+0)
290   01E0 5F           	ld e,a
291   01E1 7A           	ld a,d
292   01E2 DD 8E 01     	adc (ix+1)
293   01E5 57           	ld d,a
294   01E6 7D           	ld a,l
295   01E7 DD 8E 02     	adc (ix+2)
296   01EA 6F           	ld l,a
297   01EB DD 23        	inc ix
298   01ED DD 23        	inc ix
299   01EF DD 23        	inc ix
300   01F1 7C           	ld a,h
301   01F2 B7           	or a
302   01F3 20 07        	jr nz,prd3
303   01F5 79           	ld a,c
304   01F6 FE 30        	cp "0"
305   01F8 3E 20        	ld a," "
306   01FA 28 03        	jr z,prd4
307   01FC              prd3
308   01FC 79           	ld a,c
309   01FD 26 01        	ld h,1
310   01FF              prd4
311   01FF CD 74 01     	call print_char
312   0202 10 C4        	djnz lp_pdw1
313   0204 C9           	ret
314   0205              dectb_w
315   0205 80 96 98     	db #80,#96,#98		; 10000000 decimal
316   0208 40 42 0F     	db #40,#42,#0f		; 1000000
317   020B A0 86 01     	db #a0,#86,#01		; 100000
318   020E 10 27 00     	db #10,#27,0		; 10000
319   0211 E8 03 00     	db #e8,#03,0		; 1000
320   0214 64 00 00     	db 100,0,0		; 100
321   0217 0A 00 00     	db 10,0,0		; 10
322   021A 01 00 00     	db 1,0,0		; 1
323   021D
324   021D
325   021D
326   021D              ; -----------------------------------------------------------------------------
327   021D              ; управляющие коды
328   021D              ; 13 (0x0d)		- след строка
329   021D              ; 23 (0x17),x,y		- изменить позицию на координаты x,y
330   021D              ; 24 (0x18),x		- изменить позицию по x
331   021D              ; 25 (0x19),y		- изменить позицию по y
332   021D              ; 0			- конец строки
333   021D
334   021D              ; x(0-127),y(0-7)
335   021D
336   021D              menu
337   021D 17 00 00     	db 23,0,0
338   0220              ;	db "--------------------------------------------------------------------------------------------------------------------------------"
339   0220
340   0220 42 6F 61 72  	db "Board:DivGMX(Test!) SoftCore:Basic(build 20170508 By MVV) "
340   0224 64 3A 44 69
340   0228 76 47 4D 58
340   022C 28 54 65 73
340   0230 74 21 29 20
340   0234 53 6F 66 74
340   0238 43 6F 72 65
340   023C 3A 42 61 73
340   0240 69 63 28 62
340   0244 75 69 6C 64
340   0248 20 32 30 31
340   024C 37 30 35 30
340   0250 38 20 42 79
340   0254 20 4D 56 56
340   0258 29 20
341   025A 46 31 3D 4F  	db "F1=OSD(nZ80@40MHz,RAM 4K,F5=Std/ROM,F6=ZC/DivMMC,F7=Std/USBKeyb)",13
341   025E 53 44 28 6E
341   0262 5A 38 30 40
341   0266 34 30 4D 48
341   026A 7A 2C 52 41
341   026E 4D 20 34 4B
341   0272 2C 46 35 3D
341   0276 53 74 64 2F
341   027A 52 4F 4D 2C
341   027E 46 36 3D 5A
341   0282 43 2F 44 69
341   0286 76 4D 4D 43
341   028A 2C 46 37 3D
341   028E 53 74 64 2F
341   0292 55 53 42 4B
341   0296 65 79 62 29
341   029A 0D
342   029B 53 79 73 74  	db "System[7FFD:00 xxFE:00 PC:0000 ROM:Std KBD:Std BDI:0]",13
342   029F 65 6D 5B 37
342   02A3 46 46 44 3A
342   02A7 30 30 20 78
342   02AB 78 46 45 3A
342   02AF 30 30 20 50
342   02B3 43 3A 30 30
342   02B7 30 30 20 52
342   02BB 4F 4D 3A 53
342   02BF 74 64 20 4B
342   02C3 42 44 3A 53
342   02C7 74 64 20 42
342   02CB 44 49 3A 30
342   02CF 5D 0D
343   02D1 44 69 76 4D  	db "DivMMC[xxE3:00 AMAP:0 On ] Mouse0[FADF:00 FBDF:00 FFDF:00] "
343   02D5 4D 43 5B 78
343   02D9 78 45 33 3A
343   02DD 30 30 20 41
343   02E1 4D 41 50 3A
343   02E5 30 20 4F 6E
343   02E9 20 5D 20 4D
343   02ED 6F 75 73 65
343   02F1 30 5B 46 41
343   02F5 44 46 3A 30
343   02F9 30 20 46 42
343   02FD 44 46 3A 30
343   0301 30 20 46 46
343   0305 44 46 3A 30
343   0309 30 5D 20
344   030C 4D 6F 75 73  	db "Mouse1[xADF:00 xBDF:00 xFFD:00] SounDrive[0F:00 1F:00 4F:00 5F/FB:00]",0
344   0310 65 31 5B 78
344   0314 41 44 46 3A
344   0318 30 30 20 78
344   031C 42 44 46 3A
344   0320 30 30 20 78
344   0324 46 46 44 3A
344   0328 30 30 5D 20
344   032C 53 6F 75 6E
344   0330 44 72 69 76
344   0334 65 5B 30 46
344   0338 3A 30 30 20
344   033C 31 46 3A 30
344   0340 30 20 34 46
344   0344 3A 30 30 20
344   0348 35 46 2F 46
344   034C 42 3A 30 30
344   0350 5D 00
345   0352              str_off
346   0352 4F 66 66 00  	db "Off",0
347   0356              str_on
348   0356 4F 6E 20 00  	db "On ",0
349   035A              str_usb
350   035A 55 53 42 00  	db "USB",0
351   035E              str_std
352   035E 53 74 64 00  	db "Std",0
353   0362              list
354   0362 00 00 00 00  	db 0,0,0,0,0,0,0,0,0
354   0366 00 00 00 00
354   036A 00
355   036B
356   036B              ;	org #0c00
357   036B              ;	db "--------------------------------------------------------------------------------------------------------------------------------"
358   036B              ;	db "DivGMX[Rev.A Ultimate] SoftCore[Basic(build 20170112) By MVV] OSD[CPU:NZ80@28MHz RAM:4K F5=Std/ROM F6=ZC/DivMMC F7=Std/USBKeyb]                              "
359   036B              ;	db "System [7FFD:00 xxFE:00 1FFD:00]                                                                                                "
360   036B              ;	db "DivMMC [xxE3:00 xxE7:00 AMAP:0 ]-----------------------------------------------------------------------------------------------4"
361   036B              ;	db "Mouse0   [FADF:00 FBDF:00 FFDF:00]                                                                                              "
362   036B              ;	db "Mouse1   [0ADF:00 0BDF:00 0FFD:00]                                                                          -------------------6"
363   036B              ;	db "SounDrive[xx0F:00 xx1F:00 xx4F:00 xx5F:00 xxFB:00]-----------------------------------------------------------------------------3"
364   036B              ;	db "Addr:0000----------------------------------------------------------------------------------------------------------------------2"
365   036B              ;	db "6------------------------------------------------------------------------------------------------------------------------------1"
366   036B              ;	db "7------------------------------------------------------------------------------------------------------------------------------0"
367   036B
368   036B              ; -----------------------------------------------------------------------------
369   036B
370   036B              	display "Code start: ",/a, startprog, " end: ",/a, $-1
371   036B              	display "OSD buffer start: ",/a, osd_buffer, " end: ",/a, osd_buffer + osd_buffer_size - 1
372   036B
373   036B              	savebin "test.bin",startprog, 4096
374   036B
# file closed: test.asm
